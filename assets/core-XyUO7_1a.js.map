{"version":3,"file":"core-XyUO7_1a.js","sources":["../../src/core/utils.js","../../src/ui/sandbox.js","../../src/core/sandbox.js","../../src/core/console.js","../../src/core/events.js"],"sourcesContent":["/**\r\n * Utility functions for the sandbox application\r\n * @author Joao Guilherme (Guinetik) <guinetik@gmail.com>\r\n */\r\n\r\nimport { NETWORK_TIMEOUT_MS } from './constants.js';\r\n\r\n/**\r\n * Creates a fetch request with timeout\r\n * @param {string} url - The URL to fetch\r\n * @param {Object} options - Fetch options\r\n * @param {number} timeout - Timeout in milliseconds\r\n * @returns {Promise<Response>} The fetch response\r\n */\r\nexport async function fetchWithTimeout(url, options = {}, timeout = NETWORK_TIMEOUT_MS) {\r\n  const controller = new AbortController();\r\n  const timeoutId = setTimeout(() => controller.abort(), timeout);\r\n  \r\n  try {\r\n    const response = await fetch(url, {\r\n      ...options,\r\n      signal: controller.signal\r\n    });\r\n    clearTimeout(timeoutId);\r\n    return response;\r\n  } catch (error) {\r\n    clearTimeout(timeoutId);\r\n    if (error.name === 'AbortError') {\r\n      throw new Error(`Request timeout after ${timeout}ms`);\r\n    }\r\n    throw error;\r\n  }\r\n}\r\n\r\n/**\r\n * Escapes HTML to prevent XSS\r\n * @param {string} text - Text to escape\r\n * @returns {string} Escaped text\r\n */\r\nexport function escapeHtml(text) {\r\n  const div = document.createElement('div');\r\n  div.textContent = text;\r\n  return div.innerHTML;\r\n}\r\n\r\n/**\r\n * Debounces a function\r\n * @param {Function} func - Function to debounce\r\n * @param {number} wait - Wait time in milliseconds\r\n * @returns {Function} Debounced function\r\n */\r\nexport function debounce(func, wait) {\r\n  let timeout;\r\n  return function executedFunction(...args) {\r\n    const later = () => {\r\n      clearTimeout(timeout);\r\n      func(...args);\r\n    };\r\n    clearTimeout(timeout);\r\n    timeout = setTimeout(later, wait);\r\n  };\r\n}\r\n\r\n/**\r\n * Throttles a function\r\n * @param {Function} func - Function to throttle\r\n * @param {number} limit - Time limit in milliseconds\r\n * @returns {Function} Throttled function\r\n */\r\nexport function throttle(func, limit) {\r\n  let inThrottle;\r\n  return function executedFunction(...args) {\r\n    if (!inThrottle) {\r\n      func(...args);\r\n      inThrottle = true;\r\n      setTimeout(() => inThrottle = false, limit);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Creates a safe JSON stringify that handles circular references\r\n * @param {any} obj - Object to stringify\r\n * @param {number} space - Spacing for formatting\r\n * @returns {string} JSON string\r\n */\r\nexport function safeStringify(obj, space = 2) {\r\n  const seen = new WeakSet();\r\n  return JSON.stringify(obj, (key, value) => {\r\n    if (typeof value === 'object' && value !== null) {\r\n      if (seen.has(value)) {\r\n        return '[Circular]';\r\n      }\r\n      seen.add(value);\r\n    }\r\n    if (typeof Node !== 'undefined' && value instanceof Node) {\r\n      return '<' + (value.nodeName || 'node').toLowerCase() + '>';\r\n    }\r\n    if (value instanceof Error) {\r\n      return value.stack || value.message || String(value);\r\n    }\r\n    return value;\r\n  }, space);\r\n}\r\n\r\n/**\r\n * Checks if device is mobile based on viewport width\r\n * @param {number} breakpoint - Mobile breakpoint in pixels\r\n * @returns {boolean} True if mobile\r\n */\r\nexport function isMobile(breakpoint = 768) {\r\n  return window.matchMedia(`(max-width: ${breakpoint}px)`).matches;\r\n}\r\n\r\n/**\r\n * Creates a promise that resolves after a delay\r\n * @param {number} ms - Delay in milliseconds\r\n * @returns {Promise<void>}\r\n */\r\nexport function delay(ms) {\r\n  return new Promise(resolve => setTimeout(resolve, ms));\r\n}\r\n\r\n/**\r\n * Sanitizes code for safe template injection\r\n * @param {string} code - Code to sanitize\r\n * @returns {string} Sanitized code\r\n */\r\nexport function sanitizeCode(code) {\r\n  // Escape closing script tags to prevent breaking out of the script context\r\n  return code.replace(/<\\/(script)/gi, '<\\\\/$1');\r\n}\r\n","import { Logger } from '../core/logger.js';\r\nimport { fetchWithTimeout, sanitizeCode } from '../core/utils.js';\r\nimport {\r\n  TEMPLATE_LOAD_TIMEOUT_MS,\r\n  DEFAULT_TEMPLATE_PATH,\r\n  TEMPLATE_MARKERS\r\n} from '../core/constants.js';\r\n\r\n/**\r\n * Template engine for building sandboxed HTML execution environments\r\n * @author Joao Guilherme (Guinetik) <guinetik@gmail.com>\r\n */\r\nexport class TemplateEngine {\r\n  /**\r\n   * Creates a new TemplateEngine instance\r\n   * @param {string} [templatePath] - Path to the HTML template file\r\n   * @param {Object} [options={}] - Configuration options\r\n   * @param {boolean} [options.debug=true] - Enable debug logging\r\n   * @param {string} [options.logLevel='info'] - Log level for debugging\r\n   */\r\n  constructor(templatePath = DEFAULT_TEMPLATE_PATH, options = {}) {\r\n    this.templatePath = templatePath;\r\n    this.template = null;\r\n    this.isLoaded = false;\r\n    this.logger = new Logger({\r\n      enabled: options.debug !== false,\r\n      level: options.logLevel || 'info',\r\n      prefix: 'TemplateEngine',\r\n      redactSecrets: true\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Forces a reload of the template from disk\r\n   */\r\n  forceReload() {\r\n    this.logger.info('Force reloading template...');\r\n    this.template = null;\r\n    this.isLoaded = false;\r\n  }\r\n\r\n  /**\r\n   * Initializes the template engine by loading the HTML template\r\n   * @returns {Promise<void>}\r\n   */\r\n  async initialize() {\r\n    this.logger.info('Starting initialization...');\r\n    if (this.isLoaded) {\r\n      this.logger.debug('Already loaded, skipping');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      this.logger.debug('Fetching template from:', this.templatePath);\r\n      // Add cache busting to force reload\r\n      const cacheBuster = '?t=' + Date.now();\r\n      const response = await fetchWithTimeout(\r\n        this.templatePath + cacheBuster,\r\n        {},\r\n        TEMPLATE_LOAD_TIMEOUT_MS\r\n      );\r\n      \r\n      if (!response.ok) {\r\n        throw new Error(`Failed to load template: ${response.status}`);\r\n      }\r\n      \r\n      this.template = await response.text();\r\n      \r\n      // Validate template has required markers\r\n      this.validateTemplate();\r\n      \r\n      this.logger.info('Template loaded successfully, length:', this.template.length);\r\n      this.logger.debug('Template preview:', this.template.substring(0, 200) + '...');\r\n      this.isLoaded = true;\r\n    } catch (error) {\r\n      this.logger.error('Failed to load sandbox template:', error.message);\r\n      this.logger.warn('Using fallback template');\r\n      this.template = this.getFallbackTemplate();\r\n      this.isLoaded = true;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Validates that the template contains required markers\r\n   * @throws {Error} If template is missing required markers\r\n   */\r\n  validateTemplate() {\r\n    const requiredMarkers = [\r\n      TEMPLATE_MARKERS.SECRET,\r\n      TEMPLATE_MARKERS.USER_CODE,\r\n      TEMPLATE_MARKERS.DYNAMIC_CSP,\r\n      TEMPLATE_MARKERS.LIBRARY_SCRIPTS\r\n    ];\r\n\r\n    const missingMarkers = requiredMarkers.filter(\r\n      marker => !this.template.includes(marker)\r\n    );\r\n\r\n    if (missingMarkers.length > 0) {\r\n      throw new Error(\r\n        `Template missing required markers: ${missingMarkers.join(', ')}`\r\n      );\r\n    }\r\n\r\n    this.logger.debug('Template validation passed');\r\n  }\r\n\r\n  /**\r\n   * Returns a fallback HTML template when the external template file fails to load\r\n   * @returns {string} The fallback HTML template\r\n   */\r\n  getFallbackTemplate() {\r\n    return `<!doctype html>\r\n<html><head><meta charset=\"utf-8\">\r\n<meta http-equiv=\"Content-Security-Policy\" content=\"${TEMPLATE_MARKERS.DYNAMIC_CSP}\">\r\n<title>Sandbox</title>\r\n${TEMPLATE_MARKERS.LIBRARY_SCRIPTS}\r\n<style>html,body{margin:0;padding:12px;font:14px/1.4 -apple-system, system-ui, Segoe UI, Roboto} body{background:#fff;color:#111}</style>\r\n</head><body>\r\n<script>\r\n(function(){\r\n  var SECRET = \"${TEMPLATE_MARKERS.SECRET}\";\r\n\r\n  // Debug logging to sandbox console\r\n  var debug = function(msg) {\r\n    console.log('[SANDBOX DEBUG]', msg);\r\n  };\r\n\r\n  // Convert any value to a string for sending\r\n  var stringify = function(val) {\r\n    if (val === undefined) return 'undefined';\r\n    if (val === null) return 'null';\r\n    if (typeof val === 'string') return val;\r\n    if (typeof val === 'number' || typeof val === 'boolean') return String(val);\r\n\r\n    // Handle Error objects specially\r\n    if (val instanceof Error) {\r\n      var errorStr = val.name + ': ' + val.message;\r\n      if (val.stack) {\r\n        // Clean up the stack trace\r\n        var lines = val.stack.split('\\\\n');\r\n        var cleaned = [];\r\n        for (var i = 0; i < lines.length; i++) {\r\n          var line = lines[i];\r\n          if (i === 0) {\r\n            cleaned.push(line); // Keep error message\r\n          } else if (line.indexOf('<anonymous>') !== -1) {\r\n            // Extract line and column numbers\r\n            var match = line.match(/:(\\d+):(\\d+)/);\r\n            if (match) {\r\n              cleaned.push('    at line ' + match[1] + ', column ' + match[2]);\r\n            }\r\n          }\r\n        }\r\n        errorStr = cleaned.join('\\\\n');\r\n      }\r\n      return errorStr;\r\n    }\r\n\r\n    // Try to stringify objects\r\n    try {\r\n      return JSON.stringify(val);\r\n    } catch(e) {\r\n      return Object.prototype.toString.call(val);\r\n    }\r\n  };\r\n\r\n  var send = function(type){\r\n    var args = Array.prototype.slice.call(arguments, 1);\r\n    // Make sure all arguments are strings\r\n    var stringArgs = [];\r\n    for (var i = 0; i < args.length; i++) {\r\n      stringArgs.push(stringify(args[i]));\r\n    }\r\n\r\n    debug('Sending ' + type + ' message with ' + stringArgs.length + ' args');\r\n\r\n    try {\r\n      parent.postMessage({\r\n        __sandbox: true,\r\n        secret: SECRET,\r\n        type: type,\r\n        args: stringArgs\r\n      }, \"*\");\r\n    } catch(e) {\r\n      debug('Failed to send message: ' + e.message);\r\n    }\r\n  };\r\n\r\n  // Override console methods\r\n  [\"log\",\"info\",\"warn\",\"error\"].forEach(function(m){\r\n    var original = console[m];\r\n    console[m] = function(){\r\n      var args = Array.prototype.slice.call(arguments);\r\n      send.apply(null, [m].concat(args));\r\n      // Still call original for debugging\r\n      if (original && original.apply) {\r\n        try { original.apply(console, arguments); } catch(_) {}\r\n      }\r\n    };\r\n  });\r\n\r\n  // Global error handler\r\n  window.addEventListener(\"error\", function(e){\r\n    debug('Error event caught');\r\n    debug('Error object: ' + e.error);\r\n    debug('Error message: ' + e.message);\r\n    debug('Error lineno: ' + e.lineno);\r\n\r\n    var errorMsg = '';\r\n    if (e.error) {\r\n      // Extract error details manually since stringify might fail\r\n      var err = e.error;\r\n      errorMsg = (err.name || 'Error') + ': ' + (err.message || 'Unknown error');\r\n\r\n      // Try to get stack trace\r\n      if (err.stack) {\r\n        var lines = err.stack.split('\\\\n');\r\n        // First line is usually the error message, skip it if it's redundant\r\n        var startIdx = (lines[0].indexOf(err.message) !== -1) ? 1 : 0;\r\n\r\n        for (var i = startIdx; i < lines.length; i++) {\r\n          var line = lines[i].trim();\r\n          if (line) {\r\n            // Clean up the stack trace line\r\n            var match = line.match(/at\\\\s+(?:(.+?)\\\\s+\\\\()?(?:.+?):(\\\\d+):(\\\\d+)/);\r\n            if (match) {\r\n              var fnName = match[1] || 'anonymous';\r\n              errorMsg += '\\\\n    at ' + fnName + ' (line ' + match[2] + ', column ' + match[3] + ')';\r\n            } else if (line.indexOf('at ') === 0) {\r\n              // Keep other 'at' lines but clean them up\r\n              errorMsg += '\\\\n    ' + line;\r\n            }\r\n          }\r\n        }\r\n      } else if (e.lineno) {\r\n        // Fallback to basic location info\r\n        errorMsg += '\\\\n    at line ' + e.lineno + ', column ' + e.colno;\r\n      }\r\n    } else {\r\n      // Fallback when no error object\r\n      errorMsg = e.message || 'Unknown error';\r\n      if (e.lineno) {\r\n        errorMsg += '\\\\n    at line ' + e.lineno + ', column ' + e.colno;\r\n      }\r\n    }\r\n\r\n    debug('Formatted error: ' + errorMsg);\r\n    send(\"error\", errorMsg);\r\n\r\n    // Prevent default browser error handling\r\n    e.preventDefault();\r\n    return true;\r\n  });\r\n\r\n  // Handle promise rejections\r\n  window.addEventListener(\"unhandledrejection\", function(e){\r\n    debug('Unhandled rejection caught');\r\n    var errorMsg = \"Unhandled Promise Rejection: \" + stringify(e.reason);\r\n    send(\"error\", errorMsg);\r\n    e.preventDefault();\r\n    return true;\r\n  });\r\n\r\n  // Execute user code\r\n  debug('Executing user code...');\r\n  try {\r\n${TEMPLATE_MARKERS.USER_CODE}\r\n  } catch (err) {\r\n    debug('Caught error in try-catch: ' + err.message);\r\n    send(\"error\", stringify(err));\r\n  }\r\n\r\n  // Signal completion\r\n  setTimeout(function(){\r\n    debug('Sending done signal');\r\n    send(\"done\");\r\n  }, 0);\r\n})();\r\n</script>\r\n</body></html>`;\r\n  }\r\n\r\n  /**\r\n   * Builds an HTML document with user code and security token injected\r\n   * @param {string} userCode - The user's JavaScript code to execute\r\n   * @param {string} secret - Security token for sandboxed communication\r\n   * @param {string} [libraryScripts=''] - HTML script tags for libraries\r\n   * @param {string} [dynamicCSP] - Dynamic CSP policy string\r\n   * @returns {string} Complete HTML document ready for iframe execution\r\n   */\r\n  buildSrcDoc(userCode, secret, libraryScripts = '', dynamicCSP = null) {\r\n    this.logger.debug('Building srcDoc...');\r\n    if (!this.isLoaded) {\r\n      throw new Error('TemplateEngine not initialized. Call initialize() first.');\r\n    }\r\n\r\n    // Sanitize user code\r\n    const sanitized = sanitizeCode(userCode);\r\n    const secretValue = String(secret);\r\n\r\n    // Add sourceURL to user code for better debugging and line number tracking\r\n    const userCodeWithSourceMap = `//# sourceURL=user-code.js\\n${sanitized}`;\r\n\r\n    // Use provided CSP or fallback to default\r\n    const cspPolicy = dynamicCSP || \"default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob:; connect-src 'none';\";\r\n\r\n    this.logger.trace('Replacing template markers');\r\n\r\n    // Replace all markers in sequence\r\n    let result = this.template;\r\n\r\n    result = result.replace(\r\n      new RegExp(this.escapeRegExp(TEMPLATE_MARKERS.SECRET), 'g'),\r\n      secretValue\r\n    );\r\n\r\n    result = result.replace(\r\n      new RegExp(this.escapeRegExp(TEMPLATE_MARKERS.USER_CODE), 'g'),\r\n      userCodeWithSourceMap\r\n    );\r\n\r\n    result = result.replace(\r\n      new RegExp(this.escapeRegExp(TEMPLATE_MARKERS.LIBRARY_SCRIPTS), 'g'),\r\n      libraryScripts\r\n    );\r\n\r\n    result = result.replace(\r\n      new RegExp(this.escapeRegExp(TEMPLATE_MARKERS.DYNAMIC_CSP), 'g'),\r\n      cspPolicy\r\n    );\r\n\r\n    this.logger.debug('Template replacement complete');\r\n    this.logger.trace('Result preview:', result.substring(0, 500) + '...');\r\n\r\n    if (libraryScripts) {\r\n      this.logger.info('Libraries injected:', libraryScripts.split('<script').length - 1);\r\n    }\r\n\r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Escapes special regex characters in a string\r\n   * @param {string} str - String to escape\r\n   * @returns {string} Escaped string\r\n   */\r\n  escapeRegExp(str) {\r\n    return str.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\r\n  }\r\n}\r\n","import { TemplateEngine } from '../ui/sandbox.js';\r\nimport { Logger } from './logger.js';\r\nimport { DEFAULT_TIMEOUT_MS, CRYPTO_ARRAY_SIZE } from './constants.js';\r\n\r\n/**\r\n * Sandboxed JavaScript execution engine using iframe isolation\r\n * @author Joao Guilherme (Guinetik) <guinetik@gmail.com>\r\n */\r\nexport class SandboxEngine {\r\n  /**\r\n   * Creates a new SandboxEngine instance\r\n   * @param {HTMLElement} container - DOM element to contain the sandbox iframe\r\n   * @param {Object} [options={}] - Configuration options\r\n   * @param {number} [options.timeLimit] - Execution timeout in milliseconds\r\n   * @param {Function} [options.onMessage] - Callback for sandbox messages\r\n   * @param {Function} [options.onStatusChange] - Callback for status updates\r\n   * @param {string} [options.templatePath] - Path to custom sandbox template\r\n   * @param {boolean} [options.debug=true] - Enable debug logging\r\n   * @param {string} [options.logLevel='info'] - Log level for debugging\r\n   */\r\n  constructor(container, options = {}) {\r\n    this.container = container;\r\n    this.timeLimit = options.timeLimit || DEFAULT_TIMEOUT_MS;\r\n    this.onMessage = options.onMessage || (() => {});\r\n    this.onStatusChange = options.onStatusChange || (() => {});\r\n\r\n    this.iframe = null;\r\n    this.killTimer = null;\r\n    this.currentSecret = this.generateSecret();\r\n    this.messageHandler = null;\r\n\r\n    this.logger = new Logger({\r\n      enabled: options.debug !== false,\r\n      level: options.logLevel || 'info',\r\n      prefix: 'SandboxEngine',\r\n      redactSecrets: true\r\n    });\r\n\r\n    this.templateEngine = new TemplateEngine(options.templatePath, {\r\n      debug: options.debug,\r\n      logLevel: options.logLevel\r\n    });\r\n\r\n    this.createIframe();\r\n    this.setupMessageListener();\r\n  }\r\n\r\n  /**\r\n   * Initializes the sandbox engine and template system\r\n   * @returns {Promise<void>}\r\n   */\r\n  async initialize() {\r\n    this.logger.info('Initializing...');\r\n    \r\n    try {\r\n      await this.templateEngine.initialize();\r\n      this.logger.info('Template engine initialized');\r\n    } catch (error) {\r\n      this.logger.error('Template initialization failed:', error);\r\n      throw new Error(`Sandbox initialization failed: ${error.message}`);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generates a cryptographically secure random secret for sandbox communication\r\n   * @returns {string} Random secret token\r\n   */\r\n  generateSecret() {\r\n    try {\r\n      if (window.crypto && window.crypto.getRandomValues) {\r\n        const arr = new Uint32Array(CRYPTO_ARRAY_SIZE);\r\n        window.crypto.getRandomValues(arr);\r\n        return String(arr[0]) + String(arr[1]);\r\n      }\r\n    } catch (e) {\r\n      this.logger.warn('Crypto API unavailable, using fallback', e);\r\n    }\r\n    return String(Math.random()).slice(2) + Date.now();\r\n  }\r\n\r\n  /**\r\n   * Creates a new sandboxed iframe element\r\n   */\r\n  createIframe() {\r\n    // Clear the entire container to ensure no duplicates\r\n    this.container.innerHTML = '';\r\n\r\n    this.iframe = document.createElement('iframe');\r\n    this.iframe.className = 'sandbox-iframe';\r\n    this.iframe.setAttribute('sandbox', 'allow-scripts allow-modals');\r\n    this.iframe.title = 'Code Sandbox';\r\n    this.container.appendChild(this.iframe);\r\n  }\r\n\r\n  /**\r\n   * Resets the sandbox by creating a fresh iframe\r\n   */\r\n  reset() {\r\n    if (this.killTimer) {\r\n      clearTimeout(this.killTimer);\r\n      this.killTimer = null;\r\n    }\r\n    this.createIframe();\r\n    this.onStatusChange('reset');\r\n  }\r\n\r\n  /**\r\n   * Validates JavaScript syntax without executing it\r\n   * @param {string} code - The JavaScript code to validate\r\n   * @returns {Object} Validation result with {valid: boolean, error?: string}\r\n   */\r\n  validateSyntax(code) {\r\n    try {\r\n      // Use Function constructor to check syntax without executing\r\n      new Function(code);\r\n      return { valid: true };\r\n    } catch (error) {\r\n      return {\r\n        valid: false,\r\n        error: error.message,\r\n        name: error.name,\r\n        toString: () => `${error.name}: ${error.message}`\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Executes JavaScript code in the sandboxed iframe\r\n   * @param {string} code - The JavaScript code to execute\r\n   * @param {Object} [libraryData] - Optional library injection data\r\n   * @param {string} [libraryData.scripts] - HTML script tags for libraries\r\n   * @param {string} [libraryData.csp] - Dynamic CSP policy\r\n   * @returns {Promise<void>}\r\n   */\r\n  async execute(code, libraryData = null) {\r\n    this.logger.debug('Executing code...');\r\n\r\n    // Ensure template is loaded before execution\r\n    if (!this.templateEngine.isLoaded) {\r\n      this.logger.debug('Template not loaded, initializing...');\r\n      await this.templateEngine.initialize();\r\n    }\r\n\r\n    // First, validate syntax\r\n    const validation = this.validateSyntax(code);\r\n    if (!validation.valid) {\r\n      this.logger.debug('Syntax error detected:', validation.error);\r\n      this.onMessage('error', [validation.toString()]);\r\n      this.onStatusChange('completed');\r\n      return;\r\n    }\r\n\r\n    this.currentSecret = this.generateSecret();\r\n    this.logger.trace('Generated secret for execution');\r\n\r\n    // Extract library data if provided\r\n    const libraryScripts = libraryData?.scripts || '';\r\n    const dynamicCSP = libraryData?.csp || null;\r\n\r\n    const srcdoc = this.templateEngine.buildSrcDoc(code, this.currentSecret, libraryScripts, dynamicCSP);\r\n    this.logger.debug('Setting iframe srcdoc...');\r\n\r\n    if (libraryData?.scripts) {\r\n      this.logger.info('Injecting libraries into sandbox');\r\n    }\r\n\r\n    this.iframe.srcdoc = srcdoc;\r\n    this.onStatusChange('executing');\r\n\r\n    if (this.killTimer) clearTimeout(this.killTimer);\r\n    this.killTimer = setTimeout(() => {\r\n      this.onMessage('error', [`⏱️ Execution timeout (${this.timeLimit}ms). Sandbox reset.`]);\r\n      this.reset();\r\n      this.onStatusChange('timeout');\r\n    }, this.timeLimit);\r\n  }\r\n\r\n  /**\r\n   * Sets up the postMessage listener for communication with the sandboxed iframe\r\n   */\r\n  setupMessageListener() {\r\n    // Remove existing listener if any\r\n    if (this.messageHandler) {\r\n      window.removeEventListener('message', this.messageHandler);\r\n    }\r\n\r\n    // Create bound handler for proper removal later\r\n    this.messageHandler = (ev) => {\r\n      if (ev.source !== this.iframe?.contentWindow) return;\r\n\r\n      const data = ev.data || {};\r\n      this.logger.trace('Received message from iframe:', data);\r\n\r\n      if (!data.__sandbox || data.secret !== this.currentSecret) return;\r\n\r\n      const type = data.type || 'log';\r\n      const args = Array.isArray(data.args) ? data.args : [data.args];\r\n\r\n      this.logger.debug(`Processing ${type} message with ${args.length} args`);\r\n      this.logger.trace('Message args:', args);\r\n\r\n      if (type === 'done') {\r\n        if (this.killTimer) {\r\n          clearTimeout(this.killTimer);\r\n          this.killTimer = null;\r\n        }\r\n        this.onStatusChange('completed');\r\n        return;\r\n      }\r\n\r\n      // Special logging for error messages\r\n      if (type === 'error') {\r\n        this.logger.warn('Error message received from sandbox:', args);\r\n      }\r\n\r\n      this.onMessage(type, args);\r\n    };\r\n\r\n    window.addEventListener('message', this.messageHandler);\r\n  }\r\n\r\n  /**\r\n   * Cleans up the sandbox engine by removing timers and DOM elements\r\n   */\r\n  destroy() {\r\n    this.logger.info('Destroying sandbox engine...');\r\n    \r\n    if (this.killTimer) {\r\n      clearTimeout(this.killTimer);\r\n      this.killTimer = null;\r\n    }\r\n    \r\n    if (this.messageHandler) {\r\n      window.removeEventListener('message', this.messageHandler);\r\n      this.messageHandler = null;\r\n    }\r\n    \r\n    if (this.iframe) {\r\n      this.iframe.remove();\r\n      this.iframe = null;\r\n    }\r\n    \r\n    this.logger.info('Sandbox engine destroyed');\r\n  }\r\n}\r\n","import { safeStringify } from './utils.js';\r\nimport { Logger } from './logger.js';\r\n\r\n/**\r\n * Console output renderer for displaying sandboxed code execution results\r\n * @author Joao Guilherme (Guinetik) <guinetik@gmail.com>\r\n */\r\nexport class ConsoleOutput {\r\n  /**\r\n   * Creates a new ConsoleOutput instance\r\n   * @param {HTMLElement} container - The DOM element to render console output in\r\n   * @param {Object} [options={}] - Configuration options\r\n   * @param {boolean} [options.debug=false] - Enable debug logging\r\n   */\r\n  constructor(container, options = {}) {\r\n    this.container = container;\r\n    this.logger = new Logger({\r\n      enabled: options.debug || false,\r\n      level: 'warn',\r\n      prefix: 'ConsoleOutput'\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Clears all console output\r\n   */\r\n  clear() {\r\n    this.container.innerHTML = '';\r\n  }\r\n\r\n  /**\r\n   * Adds a new line to the console output\r\n   * @param {string} type - The log type (log, info, warn, error)\r\n   * @param {Array} args - The arguments to display\r\n   */\r\n  addLine(type, args) {\r\n    this.logger.debug(`Adding ${type} line with ${args.length} args`);\r\n    this.logger.trace('Args received:', args);\r\n\r\n    try {\r\n      const div = document.createElement('div');\r\n      div.className = `console-line console-${type}`;\r\n\r\n      // Process and format each argument\r\n      const formattedArgs = args.map((arg, index) => {\r\n        this.logger.trace(`Formatting arg ${index}:`, typeof arg, arg);\r\n        const formatted = this.formatArg(arg);\r\n        this.logger.trace(`Formatted result:`, formatted);\r\n        return formatted;\r\n      });\r\n\r\n      // For error messages with newlines, preserve formatting\r\n      const content = formattedArgs.join(' ');\r\n      if (type === 'error' && content.includes('\\n')) {\r\n        // Use innerHTML for multi-line errors, but escape HTML first\r\n        const escaped = content\r\n          .replace(/&/g, '&amp;')\r\n          .replace(/</g, '&lt;')\r\n          .replace(/>/g, '&gt;')\r\n          .replace(/\"/g, '&quot;')\r\n          .replace(/'/g, '&#039;')\r\n          .replace(/\\n/g, '<br>');\r\n        div.innerHTML = escaped;\r\n      } else {\r\n        div.textContent = content;\r\n      }\r\n      this.container.appendChild(div);\r\n      this.container.scrollTop = this.container.scrollHeight;\r\n\r\n      // Log what was actually displayed\r\n      this.logger.debug(`Displayed ${type} message:`, div.textContent);\r\n    } catch (error) {\r\n      this.logger.error('Failed to add console line:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Formats a value for display in the console\r\n   * @param {any} value - The value to format\r\n   * @returns {string} The formatted string representation\r\n   */\r\n  formatArg(value) {\r\n    try {\r\n      // Handle Error objects\r\n      if (value instanceof Error) {\r\n        return value.stack || value.message || String(value);\r\n      }\r\n    } catch (e) {\r\n      this.logger.warn('Error checking instanceof Error:', e);\r\n    }\r\n\r\n    const type = typeof value;\r\n    \r\n    // Handle primitive types\r\n    if (type === 'string') return value;\r\n    if (type === 'number' || type === 'boolean' || value === null) {\r\n      return String(value);\r\n    }\r\n    if (type === 'undefined') return 'undefined';\r\n\r\n    // Handle DOM nodes\r\n    try {\r\n      if (typeof Node !== 'undefined' && value instanceof Node) {\r\n        return '<' + (value.nodeName || 'node').toLowerCase() + '>';\r\n      }\r\n    } catch (e) {\r\n      this.logger.warn('Error checking instanceof Node:', e);\r\n    }\r\n\r\n    // Handle objects and arrays\r\n    try {\r\n      return safeStringify(value);\r\n    } catch (e) {\r\n      this.logger.warn('Failed to stringify value:', e);\r\n      return String(value);\r\n    }\r\n  }\r\n}\r\n","/**\r\n * Event system for external communication with the sandbox\r\n * @author Joao Guilherme (Guinetik) <guinetik@gmail.com>\r\n */\r\nexport class EventEmitter {\r\n  /**\r\n   * Creates a new EventEmitter instance\r\n   */\r\n  constructor() {\r\n    this.events = new Map();\r\n  }\r\n\r\n  /**\r\n   * Registers an event listener\r\n   * @param {string} event - The event name\r\n   * @param {Function} callback - The callback function\r\n   * @param {Object} [options={}] - Options for the listener\r\n   * @param {boolean} [options.once=false] - Whether to remove after first call\r\n   * @returns {Function} Unsubscribe function\r\n   */\r\n  on(event, callback, options = {}) {\r\n    if (!this.events.has(event)) {\r\n      this.events.set(event, []);\r\n    }\r\n\r\n    const listener = {\r\n      callback,\r\n      once: options.once || false\r\n    };\r\n\r\n    this.events.get(event).push(listener);\r\n\r\n    // Return unsubscribe function\r\n    return () => this.off(event, callback);\r\n  }\r\n\r\n  /**\r\n   * Registers a one-time event listener\r\n   * @param {string} event - The event name\r\n   * @param {Function} callback - The callback function\r\n   * @returns {Function} Unsubscribe function\r\n   */\r\n  once(event, callback) {\r\n    return this.on(event, callback, { once: true });\r\n  }\r\n\r\n  /**\r\n   * Removes an event listener\r\n   * @param {string} event - The event name\r\n   * @param {Function} callback - The callback function to remove\r\n   */\r\n  off(event, callback) {\r\n    if (!this.events.has(event)) return;\r\n\r\n    const listeners = this.events.get(event);\r\n    const index = listeners.findIndex(listener => listener.callback === callback);\r\n\r\n    if (index > -1) {\r\n      listeners.splice(index, 1);\r\n    }\r\n\r\n    // Clean up empty event arrays\r\n    if (listeners.length === 0) {\r\n      this.events.delete(event);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Emits an event to all registered listeners\r\n   * @param {string} event - The event name\r\n   * @param {...any} args - Arguments to pass to listeners\r\n   * @returns {boolean} True if any listeners were called\r\n   */\r\n  emit(event, ...args) {\r\n    if (!this.events.has(event)) return false;\r\n\r\n    const listeners = this.events.get(event);\r\n    const listenersToRemove = [];\r\n\r\n    listeners.forEach((listener, index) => {\r\n      try {\r\n        listener.callback(...args);\r\n        if (listener.once) {\r\n          listenersToRemove.push(index);\r\n        }\r\n      } catch (error) {\r\n        console.error(`Error in event listener for '${event}':`, error);\r\n      }\r\n    });\r\n\r\n    // Remove one-time listeners (in reverse order to maintain indices)\r\n    listenersToRemove.reverse().forEach(index => {\r\n      listeners.splice(index, 1);\r\n    });\r\n\r\n    // Clean up empty event arrays\r\n    if (listeners.length === 0) {\r\n      this.events.delete(event);\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n  /**\r\n   * Removes all listeners for an event, or all listeners if no event specified\r\n   * @param {string} [event] - The event name, or undefined to clear all\r\n   */\r\n  removeAllListeners(event) {\r\n    if (event) {\r\n      this.events.delete(event);\r\n    } else {\r\n      this.events.clear();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Returns an array of event names that have listeners\r\n   * @returns {Array<string>} Array of event names\r\n   */\r\n  eventNames() {\r\n    return Array.from(this.events.keys());\r\n  }\r\n\r\n  /**\r\n   * Returns the number of listeners for an event\r\n   * @param {string} event - The event name\r\n   * @returns {number} Number of listeners\r\n   */\r\n  listenerCount(event) {\r\n    return this.events.has(event) ? this.events.get(event).length : 0;\r\n  }\r\n}"],"names":["async","fetchWithTimeout","url","options","timeout","NETWORK_TIMEOUT_MS","controller","AbortController","timeoutId","setTimeout","abort","response","fetch","signal","clearTimeout","error","name","Error","isMobile","breakpoint","window","matchMedia","matches","TemplateEngine","constructor","templatePath","DEFAULT_TEMPLATE_PATH","this","template","isLoaded","logger","Logger","enabled","debug","level","logLevel","prefix","redactSecrets","forceReload","info","initialize","cacheBuster","Date","now","TEMPLATE_LOAD_TIMEOUT_MS","ok","status","text","validateTemplate","length","substring","message","warn","getFallbackTemplate","missingMarkers","TEMPLATE_MARKERS","SECRET","USER_CODE","DYNAMIC_CSP","LIBRARY_SCRIPTS","filter","marker","includes","join","buildSrcDoc","userCode","secret","libraryScripts","dynamicCSP","sanitized","replace","secretValue","String","userCodeWithSourceMap","cspPolicy","trace","result","RegExp","escapeRegExp","split","str","SandboxEngine","container","timeLimit","DEFAULT_TIMEOUT_MS","onMessage","onStatusChange","iframe","killTimer","currentSecret","generateSecret","messageHandler","templateEngine","createIframe","setupMessageListener","crypto","getRandomValues","arr","Uint32Array","CRYPTO_ARRAY_SIZE","e","Math","random","slice","innerHTML","document","createElement","className","setAttribute","title","appendChild","reset","validateSyntax","code","Function","valid","toString","execute","libraryData","validation","scripts","csp","srcdoc","removeEventListener","ev","source","contentWindow","data","__sandbox","type","args","Array","isArray","addEventListener","destroy","remove","ConsoleOutput","clear","addLine","div","content","map","arg","index","formatted","formatArg","escaped","textContent","scrollTop","scrollHeight","value","stack","Node","nodeName","toLowerCase","obj","space","seen","WeakSet","JSON","stringify","key","has","add","safeStringify","EventEmitter","events","Map","on","event","callback","set","listener","once","get","push","off","listeners","findIndex","splice","delete","emit","listenersToRemove","forEach","console","reverse","removeAllListeners","eventNames","from","keys","listenerCount"],"mappings":"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"}