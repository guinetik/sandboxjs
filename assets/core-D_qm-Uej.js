class e{constructor(e={}){this.enabled=!1!==e.enabled,this.level=e.level||"info",this.prefix=e.prefix||"",this.levels={error:0,warn:1,info:2,debug:3,trace:4},this.currentLevel=this.levels[this.level]||this.levels.info}shouldLog(e){return this.enabled&&this.levels[e]<=this.currentLevel}formatMessage(e,...t){return[(this.prefix?`[${this.prefix}] `:"")+e,...t]}error(e,...t){this.shouldLog("error")&&console.error(...this.formatMessage(e,...t))}warn(e,...t){this.shouldLog("warn")&&console.warn(...this.formatMessage(e,...t))}info(e,...t){this.shouldLog("info")&&console.info(...this.formatMessage(e,...t))}log(e,...t){this.shouldLog("info")&&console.log(...this.formatMessage(e,...t))}debug(e,...t){this.shouldLog("debug")&&console.debug(...this.formatMessage(e,...t))}trace(e,...t){this.shouldLog("trace")&&console.trace(...this.formatMessage(e,...t))}table(e,t){if(this.shouldLog("info")){const i=this.prefix?`[${this.prefix}]`:"";i&&console.log(i),console.table(e,t)}}group(e){this.shouldLog("info")&&console.group(...this.formatMessage(e))}groupCollapsed(e){this.shouldLog("info")&&console.groupCollapsed(...this.formatMessage(e))}groupEnd(){this.shouldLog("info")&&console.groupEnd()}time(e){this.shouldLog("debug")&&console.time(this.prefix?`[${this.prefix}] ${e}`:e)}timeEnd(e){this.shouldLog("debug")&&console.timeEnd(this.prefix?`[${this.prefix}] ${e}`:e)}setLevel(e){this.level=e,this.currentLevel=this.levels[e]||this.levels.info}enable(){this.enabled=!0}disable(){this.enabled=!1}isEnabled(){return this.enabled}}class t{constructor(t="./src/core/sandbox-template.html",i={}){this.templatePath=t,this.template=null,this.isLoaded=!1,this.logger=new e({enabled:!1!==i.debug,level:i.logLevel||"info",prefix:"TemplateEngine"})}forceReload(){this.logger.info("Force reloading template..."),this.template=null,this.isLoaded=!1}async initialize(){if(this.logger.info("Starting initialization..."),this.isLoaded)this.logger.debug("Already loaded, skipping");else try{this.logger.debug("Fetching template from:",this.templatePath);const e="?t="+Date.now(),t=await fetch(this.templatePath+e);if(!t.ok)throw new Error(`Failed to load template: ${t.status}`);this.template=await t.text(),this.logger.info("Template loaded successfully, length:",this.template.length),this.logger.debug("Template preview:",this.template.substring(0,200)+"..."),this.logger.debug("SECRET marker check:",this.template.includes("{{SECRET}}")?"Found {{SECRET}}":"SECRET marker missing!"),this.isLoaded=!0}catch(e){this.logger.error("Failed to load sandbox template:",e),this.logger.warn("Using fallback template"),this.template=this.getFallbackTemplate(),this.isLoaded=!0}}getFallbackTemplate(){return'<!doctype html>\n<html><head><meta charset="utf-8"><title>Sandbox</title>\n<style>html,body{margin:0;padding:12px;font:14px/1.4 -apple-system, system-ui, Segoe UI, Roboto} body{background:#fff;color:#111}</style>\n</head><body>\n<script>\n(function(){\n  var SECRET = "{{ SECRET }}";\n  var send = function(type){\n    var args = Array.prototype.slice.call(arguments,1);\n    try { parent.postMessage({ __sandbox: true, secret: SECRET, type: type, args: args }, "*"); } catch(e) {}\n  };\n  ["log","info","warn","error"].forEach ? ["log","info","warn","error"].forEach(function(m){\n    var original = console[m].bind(console);\n    console[m] = function(){ send.apply(null, [m].concat([].slice.call(arguments))); try { original.apply(console, arguments); } catch(_) {} };\n  }) : null;\n  addEventListener("error", function(e){\n    send("error", (e.error && (e.error.stack || e.error.message)) || (e.message + " @" + e.filename + ":" + e.lineno + ":" + e.colno));\n  });\n  addEventListener("unhandledrejection", function(e){\n    var r = e.reason; send("error", "Unhandled rejection: " + (r && (r.stack || r.message) || String(r)));\n  });\n  try {\n{{ USER_CODE }}\n  } catch (err) {\n    try { console.error(err); } catch(_) {}\n  } finally {\n    setTimeout(function(){ send("done"); }, 0);\n  }\n})();\n<\/script>\n</body></html>'}buildSrcDoc(e,t){if(this.logger.debug("Building srcDoc..."),!this.isLoaded)throw new Error("TemplateEngine not initialized. Call initialize() first.");const i=e.replace(/<\/(script)/gi,"<\\/$1"),s=String(t),r=`//# sourceURL=user-code.js\n${i}`;this.logger.trace("Replacing markers - SECRET:",s),this.logger.trace("Replacing markers - USER_CODE preview:",i.substring(0,100)+"..."),this.logger.trace("USER_CODE marker check:",this.template.includes("USER_CODE")?"Found USER_CODE":"USER_CODE marker missing!");const n=this.template.replace(/\{\{\s*SECRET\s*\}\}/g,s);this.logger.trace("After SECRET replacement, length:",n.length);const o=n.replace(/\{\{\s*USER_CODE\s*\}\}/g,r);return this.logger.trace("After USER_CODE replacement, length:",o.length),this.logger.debug("Template replacement complete"),this.logger.trace("Result preview:",o.substring(0,500)+"..."),o}}class i{constructor(i,s={}){this.container=i,this.timeLimit=s.timeLimit||4e3,this.onMessage=s.onMessage||(()=>{}),this.onStatusChange=s.onStatusChange||(()=>{}),this.iframe=null,this.killTimer=null,this.currentSecret=this.generateSecret(),this.logger=new e({enabled:!1!==s.debug,level:s.logLevel||"info",prefix:"SandboxEngine"}),this.templateEngine=new t(s.templatePath,{debug:s.debug,logLevel:s.logLevel}),this.createIframe(),this.setupMessageListener()}async initialize(){this.logger.info("Initializing..."),await this.templateEngine.initialize(),this.logger.info("Template engine initialized")}generateSecret(){try{if(window.crypto&&window.crypto.getRandomValues){const e=new Uint32Array(2);return window.crypto.getRandomValues(e),String(e[0])+String(e[1])}}catch(e){}return String(Math.random()).slice(2)+Date.now()}createIframe(){this.container.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.className="sandbox-iframe",this.iframe.setAttribute("sandbox","allow-scripts allow-modals"),this.iframe.title="Code Sandbox",this.container.appendChild(this.iframe)}reset(){this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null),this.createIframe(),this.onStatusChange("reset")}validateSyntax(e){try{return new Function(e),{valid:!0}}catch(t){return{valid:!1,error:t.message,name:t.name,toString:()=>`${t.name}: ${t.message}`}}}execute(e){this.logger.debug("Executing code...");const t=this.validateSyntax(e);if(!t.valid)return this.logger.debug("Syntax error detected:",t.error),this.onMessage("error",[t.toString()]),void this.onStatusChange("completed");this.currentSecret=this.generateSecret(),this.logger.trace("Generated secret:",this.currentSecret);const i=this.templateEngine.buildSrcDoc(e,this.currentSecret);this.logger.debug("Setting iframe srcdoc..."),this.iframe.srcdoc=i,this.onStatusChange("executing"),this.killTimer&&clearTimeout(this.killTimer),this.killTimer=setTimeout(()=>{this.onMessage("error",[`⏱️ Execution timeout (${this.timeLimit}ms). Sandbox reset.`]),this.reset(),this.onStatusChange("timeout")},this.timeLimit)}setupMessageListener(){window.addEventListener("message",e=>{if(e.source!==this.iframe.contentWindow)return;const t=e.data||{};if(!t.__sandbox||t.secret!==this.currentSecret)return;const i=t.type||"log",s=Array.isArray(t.args)?t.args:[t.args];if("done"===i)return this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null),void this.onStatusChange("completed");this.onMessage(i,s)})}destroy(){this.killTimer&&clearTimeout(this.killTimer),this.iframe&&this.iframe.remove()}}class s{constructor(e){this.container=e}clear(){this.container.innerHTML=""}addLine(e,t){const i=document.createElement("div");i.className=`console-line console-${e}`,i.textContent=t.map(this.formatArg).join(" "),this.container.appendChild(i),this.container.scrollTop=this.container.scrollHeight}formatArg(e){try{if(e instanceof Error)return e.stack||e.message||String(e)}catch(i){}const t=typeof e;if("string"===t)return e;if("number"===t||"boolean"===t||null===e)return String(e);if("undefined"===t)return"undefined";if("undefined"!=typeof Node&&e instanceof Node)return"<"+(e.nodeName||"node").toLowerCase()+">";try{const t=new WeakSet;return JSON.stringify(e,(e,i)=>{if("object"==typeof i&&null!==i){if(t.has(i))return"[Circular]";t.add(i)}return"undefined"!=typeof Node&&i instanceof Node?"<"+(i.nodeName||"node").toLowerCase()+">":i instanceof Error?i.stack||i.message||String(i):i},2)}catch(i){return String(e)}}}class r{constructor(){this.events=new Map}on(e,t,i={}){this.events.has(e)||this.events.set(e,[]);const s={callback:t,once:i.once||!1};return this.events.get(e).push(s),()=>this.off(e,t)}once(e,t){return this.on(e,t,{once:!0})}off(e,t){if(!this.events.has(e))return;const i=this.events.get(e),s=i.findIndex(e=>e.callback===t);s>-1&&i.splice(s,1),0===i.length&&this.events.delete(e)}emit(e,...t){if(!this.events.has(e))return!1;const i=this.events.get(e),s=[];return i.forEach((i,r)=>{try{i.callback(...t),i.once&&s.push(r)}catch(n){console.error(`Error in event listener for '${e}':`,n)}}),s.reverse().forEach(e=>{i.splice(e,1)}),0===i.length&&this.events.delete(e),!0}removeAllListeners(e){e?this.events.delete(e):this.events.clear()}eventNames(){return Array.from(this.events.keys())}listenerCount(e){return this.events.has(e)?this.events.get(e).length:0}}export{s as C,r as E,e as L,i as S};
//# sourceMappingURL=core-D_qm-Uej.js.map
