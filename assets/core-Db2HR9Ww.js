import{N as e,D as t,L as i,T as n,a as r,b as s,C as a}from"./vendor-Cr2mbvm1.js";async function o(t,i={},n=e){const r=new AbortController,s=setTimeout(()=>r.abort(),n);try{const e=await fetch(t,{...i,signal:r.signal});return clearTimeout(s),e}catch(a){if(clearTimeout(s),"AbortError"===a.name)throw new Error(`Request timeout after ${n}ms`);throw a}}function l(e=768){return window.matchMedia(`(max-width: ${e}px)`).matches}class c{constructor(e=t,n={}){this.templatePath=e,this.template=null,this.isLoaded=!1,this.logger=new i({enabled:!1!==n.debug,level:n.logLevel||"info",prefix:"TemplateEngine",redactSecrets:!0})}forceReload(){this.logger.info("Force reloading template..."),this.template=null,this.isLoaded=!1}async initialize(){if(this.logger.info("Starting initialization..."),this.isLoaded)this.logger.debug("Already loaded, skipping");else try{this.logger.debug("Fetching template from:",this.templatePath);const e="?t="+Date.now(),t=await o(this.templatePath+e,{},n);if(!t.ok)throw new Error(`Failed to load template: ${t.status}`);this.template=await t.text(),this.validateTemplate(),this.logger.info("Template loaded successfully, length:",this.template.length),this.logger.debug("Template preview:",this.template.substring(0,200)+"..."),this.isLoaded=!0}catch(e){this.logger.error("Failed to load sandbox template:",e.message),this.logger.warn("Using fallback template"),this.template=this.getFallbackTemplate(),this.isLoaded=!0}}validateTemplate(){const e=[r.SECRET,r.USER_CODE].filter(e=>!this.template.includes(e));if(e.length>0)throw new Error(`Template missing required markers: ${e.join(", ")}`);this.logger.debug("Template validation passed")}getFallbackTemplate(){return`<!doctype html>\n<html><head><meta charset="utf-8"><title>Sandbox</title>\n<style>html,body{margin:0;padding:12px;font:14px/1.4 -apple-system, system-ui, Segoe UI, Roboto} body{background:#fff;color:#111}</style>\n</head><body>\n<script>\n(function(){\n  var SECRET = "${r.SECRET}";\n  var send = function(type){\n    var args = Array.prototype.slice.call(arguments,1);\n    try { parent.postMessage({ __sandbox: true, secret: SECRET, type: type, args: args }, "*"); } catch(e) {}\n  };\n  ["log","info","warn","error"].forEach ? ["log","info","warn","error"].forEach(function(m){\n    var original = console[m].bind(console);\n    console[m] = function(){ send.apply(null, [m].concat([].slice.call(arguments))); try { original.apply(console, arguments); } catch(_) {} };\n  }) : null;\n  addEventListener("error", function(e){\n    send("error", (e.error && (e.error.stack || e.error.message)) || (e.message + " @" + e.filename + ":" + e.lineno + ":" + e.colno));\n  });\n  addEventListener("unhandledrejection", function(e){\n    var r = e.reason; send("error", "Unhandled rejection: " + (r && (r.stack || r.message) || String(r)));\n  });\n  try {\n${r.USER_CODE}\n  } catch (err) {\n    try { console.error(err); } catch(_) {}\n  } finally {\n    setTimeout(function(){ send("done"); }, 0);\n  }\n})();\n<\/script>\n</body></html>`}buildSrcDoc(e,t){if(this.logger.debug("Building srcDoc..."),!this.isLoaded)throw new Error("TemplateEngine not initialized. Call initialize() first.");const i=e.replace(/<\/(script)/gi,"<\\/$1");const n=String(t),s=`//# sourceURL=user-code.js\n${i}`;this.logger.trace("Replacing template markers");const a=this.template.replace(new RegExp(this.escapeRegExp(r.SECRET),"g"),n).replace(new RegExp(this.escapeRegExp(r.USER_CODE),"g"),s);return this.logger.debug("Template replacement complete"),this.logger.trace("Result preview:",a.substring(0,500)+"..."),a}escapeRegExp(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}}class g{constructor(e,t={}){this.container=e,this.timeLimit=t.timeLimit||s,this.onMessage=t.onMessage||(()=>{}),this.onStatusChange=t.onStatusChange||(()=>{}),this.iframe=null,this.killTimer=null,this.currentSecret=this.generateSecret(),this.messageHandler=null,this.logger=new i({enabled:!1!==t.debug,level:t.logLevel||"info",prefix:"SandboxEngine",redactSecrets:!0}),this.templateEngine=new c(t.templatePath,{debug:t.debug,logLevel:t.logLevel}),this.createIframe(),this.setupMessageListener()}async initialize(){this.logger.info("Initializing...");try{await this.templateEngine.initialize(),this.logger.info("Template engine initialized")}catch(e){throw this.logger.error("Template initialization failed:",e),new Error(`Sandbox initialization failed: ${e.message}`)}}generateSecret(){try{if(window.crypto&&window.crypto.getRandomValues){const e=new Uint32Array(a);return window.crypto.getRandomValues(e),String(e[0])+String(e[1])}}catch(e){this.logger.warn("Crypto API unavailable, using fallback",e)}return String(Math.random()).slice(2)+Date.now()}createIframe(){this.container.innerHTML="",this.iframe=document.createElement("iframe"),this.iframe.className="sandbox-iframe",this.iframe.setAttribute("sandbox","allow-scripts allow-modals"),this.iframe.title="Code Sandbox",this.container.appendChild(this.iframe)}reset(){this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null),this.createIframe(),this.onStatusChange("reset")}validateSyntax(e){try{return new Function(e),{valid:!0}}catch(t){return{valid:!1,error:t.message,name:t.name,toString:()=>`${t.name}: ${t.message}`}}}async execute(e){this.logger.debug("Executing code..."),this.templateEngine.isLoaded||(this.logger.debug("Template not loaded, initializing..."),await this.templateEngine.initialize());const t=this.validateSyntax(e);if(!t.valid)return this.logger.debug("Syntax error detected:",t.error),this.onMessage("error",[t.toString()]),void this.onStatusChange("completed");this.currentSecret=this.generateSecret(),this.logger.trace("Generated secret for execution");const i=this.templateEngine.buildSrcDoc(e,this.currentSecret);this.logger.debug("Setting iframe srcdoc..."),this.iframe.srcdoc=i,this.onStatusChange("executing"),this.killTimer&&clearTimeout(this.killTimer),this.killTimer=setTimeout(()=>{this.onMessage("error",[`⏱️ Execution timeout (${this.timeLimit}ms). Sandbox reset.`]),this.reset(),this.onStatusChange("timeout")},this.timeLimit)}setupMessageListener(){this.messageHandler&&window.removeEventListener("message",this.messageHandler),this.messageHandler=e=>{if(e.source!==this.iframe?.contentWindow)return;const t=e.data||{};if(!t.__sandbox||t.secret!==this.currentSecret)return;const i=t.type||"log",n=Array.isArray(t.args)?t.args:[t.args];if("done"===i)return this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null),void this.onStatusChange("completed");this.onMessage(i,n)},window.addEventListener("message",this.messageHandler)}destroy(){this.logger.info("Destroying sandbox engine..."),this.killTimer&&(clearTimeout(this.killTimer),this.killTimer=null),this.messageHandler&&(window.removeEventListener("message",this.messageHandler),this.messageHandler=null),this.iframe&&(this.iframe.remove(),this.iframe=null),this.logger.info("Sandbox engine destroyed")}}class h{constructor(e,t={}){this.container=e,this.logger=new i({enabled:t.debug||!1,level:"warn",prefix:"ConsoleOutput"})}clear(){this.container.innerHTML=""}addLine(e,t){try{const i=document.createElement("div");i.className=`console-line console-${e}`,i.textContent=t.map(e=>this.formatArg(e)).join(" "),this.container.appendChild(i),this.container.scrollTop=this.container.scrollHeight}catch(i){this.logger.error("Failed to add console line:",i)}}formatArg(e){try{if(e instanceof Error)return e.stack||e.message||String(e)}catch(i){this.logger.warn("Error checking instanceof Error:",i)}const t=typeof e;if("string"===t)return e;if("number"===t||"boolean"===t||null===e)return String(e);if("undefined"===t)return"undefined";try{if("undefined"!=typeof Node&&e instanceof Node)return"<"+(e.nodeName||"node").toLowerCase()+">"}catch(i){this.logger.warn("Error checking instanceof Node:",i)}try{return function(e,t=2){const i=new WeakSet;return JSON.stringify(e,(e,t)=>{if("object"==typeof t&&null!==t){if(i.has(t))return"[Circular]";i.add(t)}return"undefined"!=typeof Node&&t instanceof Node?"<"+(t.nodeName||"node").toLowerCase()+">":t instanceof Error?t.stack||t.message||String(t):t},t)}(e)}catch(i){return this.logger.warn("Failed to stringify value:",i),String(e)}}}class d{constructor(){this.events=new Map}on(e,t,i={}){this.events.has(e)||this.events.set(e,[]);const n={callback:t,once:i.once||!1};return this.events.get(e).push(n),()=>this.off(e,t)}once(e,t){return this.on(e,t,{once:!0})}off(e,t){if(!this.events.has(e))return;const i=this.events.get(e),n=i.findIndex(e=>e.callback===t);n>-1&&i.splice(n,1),0===i.length&&this.events.delete(e)}emit(e,...t){if(!this.events.has(e))return!1;const i=this.events.get(e),n=[];return i.forEach((i,r)=>{try{i.callback(...t),i.once&&n.push(r)}catch(s){console.error(`Error in event listener for '${e}':`,s)}}),n.reverse().forEach(e=>{i.splice(e,1)}),0===i.length&&this.events.delete(e),!0}removeAllListeners(e){e?this.events.delete(e):this.events.clear()}eventNames(){return Array.from(this.events.keys())}listenerCount(e){return this.events.has(e)?this.events.get(e).length:0}}export{h as C,d as E,g as S,o as f,l as i};
//# sourceMappingURL=core-Db2HR9Ww.js.map
